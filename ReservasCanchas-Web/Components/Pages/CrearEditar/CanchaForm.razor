@page "/canchas/nuevo"
@page "/canchas/editar/{Id:int}"
@using ReservasCanchas_Web.Models
@inject IHttpClientFactory HttpFactory
@inject NavigationManager NavManager
@inject IJSRuntime JS

<h3>@(Id == 0 ? "Nueva cancha" : "Editar cancha")</h3>

<EditForm Model="model" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Nombre</label>
        <InputText class="form-control" @bind-Value="model.Nombre" />
    </div>

    <div class="mb-3">
        <label class="form-label">Ubicación</label>
        <InputText class="form-control" @bind-Value="model.Ubicacion" />
    </div>

    <div class="mb-3">
        <label class="form-label">Tipo</label>
        <InputText class="form-control" @bind-Value="model.Tipo" />
    </div>

    <div class="mb-3">
        <label class="form-label">Precio / hora</label>
        <InputNumber class="form-control" @bind-Value="model.PrecioHora" />
    </div>

    <button class="btn btn-primary" type="submit">Guardar</button>
    <button class="btn btn-secondary ms-2" type="button" @onclick="Cancelar">Cancelar</button>
</EditForm>

@code {
    [Parameter]
    public int Id { get; set; }

    private Cancha model = new Cancha();
    private HttpClient Api => HttpFactory.CreateClient("ApiClient");

    protected override async Task OnInitializedAsync()
    {
        if (Id != 0)
        {
            var fetched = await Api.GetFromJsonAsync<Cancha>($"api/canchas/{Id}");
            if (fetched != null) model = fetched;
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            if (Id == 0)
            {
                var resp = await Api.PostAsJsonAsync("api/canchas", model);
                if (resp.IsSuccessStatusCode)
                {
                    NavManager.NavigateTo("/canchas");
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", $"Error creando cancha: {resp.ReasonPhrase}");
                }
            }
            else
            {
                var resp = await Api.PutAsJsonAsync($"api/canchas/{Id}", model);
                if (resp.IsSuccessStatusCode)
                {
                    NavManager.NavigateTo("/canchas");
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", $"Error actualizando cancha: {resp.ReasonPhrase}");
                }
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private void Cancelar() => NavManager.NavigateTo("/canchas");
}